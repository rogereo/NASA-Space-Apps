// Data variables
let allData = [];
let filteredData = [];
let columns = [];

// Pagination variables
const recordsPerPage = 10;
let currentPage = 1;
let totalPages = 1;

// Update copyright year automatically
document.getElementById('current-year').textContent = new Date().getFullYear();

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    initializeEventListeners();
});

// Load data from CSV
async function loadData() {
    try {
        const response = await fetch('https://detwet.com/data.csv');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        parseCSVData(csvText);
    } catch (error) {
        console.error('Error loading data:', error);
        showError(`Failed to load data: ${error.message}`);
    }
}

// Parse CSV data
function parseCSVData(csvText) {
    try {
        const lines = csvText.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) {
            throw new Error('CSV file is empty');
        }
        
        // Extract all column headers from CSV
        const allColumns = lines[0].split(',').map(col => col.trim());
        
        // Select only the first 8 columns
        columns = allColumns.slice(0, 8);
        
        // If fewer than 8 columns are available, log a warning
        if (columns.length < 8) {
            console.warn(`CSV contains only ${columns.length} columns, expected 8. Available columns: ${columns.join(', ')}`);
        }
        
        // Get indices of selected columns for data parsing
        const columnIndices = columns.map(col => allColumns.indexOf(col));
        
        // Parse data rows
        allData = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const row = {};
            
            columns.forEach((col, index) => {
                const colIndex = columnIndices[index];
                row[col] = values[colIndex] ? values[colIndex].trim() : '';
            });
            
            // Include GIF and NASA URL if they exist in the CSV
            const gifIndex = allColumns.indexOf('gif') !== -1 ? allColumns.indexOf('gif') : allColumns.indexOf('gif_url');
            const nasaIndex = allColumns.indexOf('nasa_url') !== -1 ? allColumns.indexOf('nasa_url') : allColumns.indexOf('nasa');
            if (gifIndex !== -1) row['gif'] = values[gifIndex] ? values[gifIndex].trim() : '';
            if (nasaIndex !== -1) row['nasa_url'] = values[nasaIndex] ? values[nasaIndex].trim() : '';
            
            allData.push(row);
        }
        
        // Update stats and render table
        updateStats();
        filteredData = allData;
        totalPages = Math.ceil(filteredData.length / recordsPerPage);
        renderTable();
        updatePaginationControls();
        renderPageNumbers();
        
        // Hide loading indicator and show table
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('tableContent').style.display = 'block';
        
    } catch (error) {
        console.error('Error parsing CSV:', error);
        showError(`Failed to parse data: ${error.message}`);
    }
}

// Update statistics
function updateStats() {
    document.getElementById('totalRecords').textContent = allData.length;
    document.getElementById('totalColumns').textContent = columns.length;
    document.getElementById('featuresTracked').textContent = 8; // Fixed to 8 as per requirement
}
